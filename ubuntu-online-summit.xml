<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Ubuntu Online Summit">
    <Require feature="rpc" />
    <Require feature="views" />
    <Require feature="locked-domain" />
  </ModulePrefs>
  <Content type="html"><![CDATA[

<html>
<!--<style type="text/css">

.button {
  border-radius: 3px;
  -moz-border-radius: 3px;
  background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#ddd));
  background: -moz-linear-gradient(top, #fff, #ddd);
  border: 1px solid #bbb;
}

.button:active {
  background: -webkit-gradient(linear, left top, left bottom, from(#aaa), to(#333));
  background: -moz-linear-gradient(bottom, #ddd, #aaa); }

</style>-->
<script src="https://plus.google.com/hangouts/_/api/dev/hangout.js"></script>

<body>

<h3>Ubuntu Online Summit Autosetup</h3>
<div id="token"></div>
<div id="ho-url"></div>
<div id="youtube-url"></div>
<button id="start">Start Overlay</button>

<audio id="introMusic">
  <source src="https://people.canonical.com/~didrocks/uos/res/intro_uos.mp3" type="audio/mpeg">
</audio>

<script>

var ANIMATIONTIME = 3000;
var startOverlay = null;
var sessionTitleOverlay = null;

var config = {};

/****************************** FADE/OVERLAY tools ******************************/
var tools = {};
tools.wrapText = function (context, text, x, y, maxWidth, lineHeight) {
  var words = text.split(' ');
  var line = '';

  for(var n = 0; n < words.length; n++) {
    var testLine = line + words[n] + ' ';
    var metrics = context.measureText(testLine);
    var testWidth = metrics.width;
    if (testWidth > maxWidth && n > 0) {
      context.fillText(line, x + (maxWidth - context.measureText(line).width) / 2, y);
      line = words[n] + ' ';
      y += lineHeight;
    }
    else {
      line = testLine;
    }
  }
  context.fillText(line, x + (maxWidth - context.measureText(line).width) / 2, y);
}

/* overlay currently fading in or fading out */
tools._fader = function(overlay, starttime, endtime, fading, ondonecb) {
  var progress, elapsed, opacity;

  // compute progress and cap it
  progress = parseFloat((new Date()).getTime() - starttime) / (endtime - starttime);
  progress = Math.min(progress, 1.0);
  if (fading) {
    opacity = progress;
  } else {
    opacity = 1 - progress;
  }

  overlay.setOpacity(opacity);

  if (progress < 1) {
    requestAnimationFrame(function () {
      tools._fader(overlay, starttime, endtime, fading, ondonecb);
    })
  } else {
    if (!fading) {
      overlay.setVisible(false);
      // TODO: dispose elements
    }
    ondonecb(overlay);
  }
}

tools.showOverlay = function(overlay) {
  overlay.setOpacity(1);
  overlay.setVisible(true);
}

tools.fadein = function(overlay, ondonecb) {
  tools.showOverlay(overlay);
  now = (new Date()).getTime();
  this._fader(overlay, now, now+ANIMATIONTIME, true, ondonecb);
}

tools.fadeout = function(overlay, ondonecb) {
  overlay.setOpacity(1);
  overlay.setVisible(true);
  now = (new Date()).getTime();
  this._fader(overlay, now, now+ANIMATIONTIME, false, ondonecb);
}
/**************************** END FADE/OVERLAY tools ****************************/

function _createFullScreenCanvas() {
  // Create a canvas to draw on
  var canvas = document.createElement('canvas');
  // try to set HD for the canvas (returns 480 by default here, even if quality is set to HD)
  var videoSize = gapi.hangout.layout.getVideoCanvas().setWidth(1280);
  canvas.setAttribute('width', videoSize.width);
  canvas.setAttribute('height', videoSize.height);
  return canvas;
}

/* orange background */
function fillBackground(canvas) {
  var context = canvas.getContext('2d');
  context.fillStyle = '#DD4814';
  context.fillRect(0, 0, canvas.width, canvas.height);
}

/* create in sync an ubuntu icon so that we can then draw and position it immediately */
function loadUbuntuIcon() {
  var logo = new Image();
  logo.src = "data:image/png;base64,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";
  return logo;
}

/* set font config in canvas context */
function _setFontConfig(context, size) {
  context.font = size + 'pt Ubuntu';
  context.lineWidth = 6;
  context.fillStyle = '#FFF';
  context.fillColor = '#FFF';
  context.textBaseline = 'center';
}

/* create the main overlay containing logo and UOS title used as a start overlay */
function createStartOverlay(title) {
  var canvas = _createFullScreenCanvas();
  var context = canvas.getContext('2d');

  // background
  fillBackground(canvas);

  // center logo
  var logo = loadUbuntuIcon();
  context.drawImage(logo, canvas.width / 2 - logo.width / 2, canvas.height / 2 - logo.height / 2);

  // UOS title
  _setFontConfig(context, 40);
  var lineHeight = 48;
  var maxWidth = 900;
  var marge_x = (canvas.width - maxWidth) / 2;
  var y = 100;
  tools.wrapText(context, title, marge_x, y, maxWidth, lineHeight);

  _setFontConfig(context, 12);
  context.textAlign = 'left';
  var y = canvas.height - 100;
  var musiccredit = ['Music: "Life of Riley" Kevin MacLeod (incompetech.com)',
                    'Licensed under Creative Commons: By Attribution 3.0',
                    'http://creativecommons.org/licenses/by/3.0/']
  for (line of musiccredit) {
    context.fillText(line, 5, y);
    y = y + 20;
  }

  return gapi.hangout.av.effects.createImageResource(canvas.toDataURL()).createOverlay();
}

/* create session title and IRC channel (+ music credit) overlay */
function createSessionOverlay(topic, irc_chan) {
  var canvas = _createFullScreenCanvas();
  var context = canvas.getContext('2d');

  var maxWidth = 900;
  _setFontConfig(context, 32);
  var lineHeight = 32;
  var marge_x = (canvas.width - maxWidth) / 2;
  var y = canvas.height / 2 + 200;
  tools.wrapText(context, topic, marge_x, y, maxWidth, lineHeight);

  _setFontConfig(context, 20);
  context.textAlign = 'right';
  context.fillText(irc_chan, canvas.width - marge_x, canvas.height - 25);

  return gapi.hangout.av.effects.createImageResource(canvas.toDataURL()).createOverlay();
}

function onYoutubeLiveReady(youtubeLiveId) {
  document.getElementById('youtube-url').innerHTML = youtubeLiveId.youTubeLiveId;
  // TODO: send all data to the server (broadcast url, hangout url, token)
  gapi.hangout.onair.onBroadcastingChanged.add(changeBroadcastingState);

  // We switch the main participant mirror now to avoid surprises
  gapi.hangout.av.setLocalParticipantVideoMirrored(false);

  // TODO: remove, only for debugging purposes
  document.getElementById('start').addEventListener("click", function() { changeBroadcastingState(true) })
}

function changeBroadcastingState(isBroadCasting) {
  if (isBroadCasting) {
    gapi.hangout.onair.setDisplayedParticipantInBroadcast(gapi.hangout.getLocalParticipant().id);

    // show main overlay and wait 10s before fading out
    tools.showOverlay(startOverlay);

    /* play music
     * we can't use the google hangout API for it as it doesn't work as of now with urls. It only supports wav data uri)
     */
    document.querySelector("#introMusic").play();

    // fadein intro overlay after 3 seconds
    window.setTimeout(function() {
      tools.fadein(sessionTitleOverlay, function() {});
    }, 3000);

    window.setTimeout(startEndIntro, 12000);
  }
  // TODO: delay end broadcast and show up outtro? (if API let us doing that)
}

/* fade out all intro overlays before disposing */
function startEndIntro() {
  tools.fadeout(sessionTitleOverlay, freeOverlay);
  tools.fadeout(startOverlay, introDone);
}

/* restore to normal on air state and request intro overlay freeing */
function introDone(overlay) {
  // return for local participant to the expected mirroring status
  gapi.hangout.av.setLocalParticipantVideoMirrored(true);
  gapi.hangout.onair.clearDisplayedParticipantInBroadcast();
  freeOverlay(overlay);
}

/* dispose overlays */
function freeOverlay(overlay) {
  overlay.getImageResource().dispose();
}

function init() {
  gapi.hangout.onApiReady.add(
    function(eventObj) {
      if (eventObj.isApiReady) {
        // add all functionalities to the broadcaster as he's the one who will set everything and starts the video
        if (!gapi.hangout.getLocalParticipant().isBroadcaster) {
          return;
        }

        config = JSON.parse(gapi.hangout.getStartData()) || {
          token : 'example_token',
          event_title: 'Ubuntu Online Summit Nov 2015',
          irc_chan: '#ubuntu-uos-desktop',
          hangout_topic: 'Update to bluez 5.1',
          end_tagline: 'visit us at http://summit.ubuntu.com',
        };
        document.getElementById('token').innerHTML = config;
        document.getElementById('ho-url').innerHTML = gapi.hangout.getHangoutUrl();
        gapi.hangout.onair.onYouTubeLiveIdReady.add(onYoutubeLiveReady);

        // create start overlays
        startOverlay = createStartOverlay(config.event_title);
        /* we can't use gapi.hangout.getTopic() which will work even if the user changed the topic as the API returns
           nothing (https://code.google.com/p/google-plus-platform/issues/detail?id=956).
           Use the parameter then. */
        sessionTitleOverlay = createSessionOverlay(config.hangout_topic, config.irc_chan);
      }
  });
}

// Wait for gadget to load.
gadgets.util.registerOnLoadHandler(init);
</script>
</body>
]]>
</Content>
</Module>
